<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Garden Bed Plants — Compatibility Calculator</title>


  <style>
    :root { --accent: #175226; --muted: #666; --bg: #ffffff; --alt-row: #f9f5f0; --border: #ddd; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 0;
      padding: 20px;
      color: #222;
      background: #fbfbfb;
      min-height: 100vh;
      box-sizing: border-box;
    }


    .container {
      max-width: 1100px;
      margin: 0 auto;
    }


    h1 {
      color: var(--accent);
      margin: 0 0 18px;
      font-size: 28px;
      border-bottom: 2px solid var(--accent);
      padding-bottom: 8px;
    }


    .row-plant {
      display: flex;
      gap: 18px;
      margin: 18px 0;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      flex: 1 1 240px;
      min-width: 200px;
    }
    label {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 6px;
      font-size: 14px;
    }
    select {
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      font-size: 14px;
    }


    #compatibility {
      margin: 14px 0;
      padding: 10px 12px;
      border-left: 5px solid var(--accent);
      background: #eef7ef;
      color: var(--accent);
      font-weight: 700;
      border-radius: 6px;
    }


    /* Desktop results table */
    #desktop-results {
      margin-top: 18px;
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      box-shadow: 0 6px 18px rgba(0,0,0,0.04);
    }
    #desktop-results table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
    }
    #desktop-results th {
      position: sticky;
      top: 0;
      z-index: 5;
      background: var(--accent);
      color: #fff;
      text-align: left;
      padding: 12px 14px;
      font-weight: 700;
      border-right: 1px solid rgba(0,0,0,0.05);
    }
    #desktop-results td {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      border-right: 1px solid rgba(0,0,0,0.03);
      vertical-align: top;
      word-wrap: break-word;
    }
    #desktop-results tbody tr:nth-child(even) td { background: var(--alt-row); }


    /* Mobile tables */
    #mobile-results .plant-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
      background: var(--bg);
    }
    #mobile-results .plant-table th,
    #mobile-results .plant-table td {
      border: 1px solid var(--border);
      padding: 10px;
      text-align: left;
    }
    #mobile-results .plant-table th {
      background: var(--accent);
      color: #fff;
      font-weight: 700;
    }
    #mobile-results .plant-table tbody tr:nth-child(even) td { background: var(--alt-row); }


    /* Responsive */
    @media (max-width: 768px) {
      .row-plant { flex-direction: column; }
      #desktop-results { display: none; }
    }
    @media (min-width: 769px) {
      #mobile-results { display: none; }
    }


    .plant-pair { margin: 6px 0; font-size: 16px; color: var(--accent); }
    .compat-text { font-weight: 800; margin-left: 8px; color: #175226; }
    .small-muted { color: var(--muted); font-size: 13px; margin-top: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Garden Bed Plants</h1>


    <div class="row-plant">
      <div class="input-group">
        <label for="dropdown1">Choose the first plant:</label>
        <select id="dropdown1"><option value="">--Select--</option></select>
      </div>
      <div class="input-group">
        <label for="dropdown2">Choose the second plant:</label>
        <select id="dropdown2"><option value="">--Select--</option></select>
      </div>
    </div>


    <div class="row-plant">
      <div class="input-group">
        <label for="dropdown3">Choose the third plant:</label>
        <select id="dropdown3"><option value="">--Select--</option></select>
      </div>
      <div class="input-group">
        <label for="dropdown4">Choose the fourth plant:</label>
        <select id="dropdown4"><option value="">--Select--</option></select>
      </div>
    </div>


    <div id="compatibility">Select plants to check compatibility.</div>


    <div id="desktop-results" aria-live="polite"></div>
    <div id="mobile-results" aria-live="polite"></div>


    <p class="small-muted">If lists don't populate check the CSV URL and that the sheet is published to the web.</p>
  </div>


  <script>
    // --- THIS IS THE FIX ---
    // We use the same proxy method that your "West Coast Planner" uses.
    const originalSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR6JO3Q9MKs9IRYy1E7bdVNb7pQMdt1VUwoeNioj3Y9Y9Rie26swdYemV6ym1eqHc3KhHYwRVD2Xv_i/pub?gid=766419629&single=true&output=csv";
    const proxyUrl = "https://corsproxy.io/?"; 
    
    // Combine them:
    const sheetUrl = proxyUrl + encodeURIComponent(originalSheetUrl);


    const DROPDOWN_IDS = ["dropdown1","dropdown2","dropdown3","dropdown4"];
    let rows = [];            
    let headerRow = [];       
    let columnNames = [];     
    let companionColumnIndex = -1; 


    // Robust CSV parser
    function parseCSV(text) {
      const result = [];
      let row = [];
      let token = '';
      let inQuotes = false;


      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i + 1];


        if (ch === '"') {
          if (inQuotes && next === '"') {
            token += '"';
            i++; 
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === ',' && !inQuotes) {
          row.push(token);
          token = '';
        } else if ((ch === '\n' || ch === '\r') && !inQuotes) {
          if (ch === '\r' && next === '\n') { i++; }
          row.push(token);
          token = '';
          result.push(row);
          row = [];
        } else {
          token += ch;
        }
      }
      if (token !== '' || row.length) {
        row.push(token);
        result.push(row);
      }
      while (result.length && result[result.length - 1].length === 1 && result[result.length - 1][0].trim() === '') {
        result.pop();
      }
      return result;
    }


    function clean(s){ return (s||'').toString().trim().toLowerCase(); }


    function detectCompanionColumn(headers) {
      if (!headers || !headers.length) return -1;
      const findIdx = headers.findIndex(h => /companion/i.test(h) || /companion plants/i.test(h) || /companion plant/i.test(h));
      if (findIdx > -1) return findIdx;
      const fallbacks = [9, 11, 8];
      for (const f of fallbacks) if (f < headers.length) return f;
      return -1;
    }


    function populateDropdowns() {
      const nameIndex = headerRow.length > 1 ? 1 : 0;
      const names = rows.slice(1).map(r => (r[nameIndex] || '').trim()).filter(n => n && n.toLowerCase() !== 'common name' && n.toLowerCase() !== 'coming soon');
      const unique = Array.from(new Set(names)).sort((a,b)=>a.localeCompare(b));


      DROPDOWN_IDS.forEach(id => {
        const dd = document.getElementById(id);
        const current = dd.value || '';
        dd.innerHTML = '<option value="">--Select--</option>';
        unique.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          dd.appendChild(opt);
        });
        if (current) dd.value = current;
        dd.addEventListener('change', updateResults);
      });
    }


    async function init() {
      const desktop = document.getElementById('desktop-results');
      const mobile = document.getElementById('mobile-results');
      const compat = document.getElementById('compatibility');


      try {
        compat.textContent = 'Loading plant data...';
        
        // Fetch via the proxy
        const res = await fetch(sheetUrl);
        if (!res.ok) throw new Error('Network response was not ok: ' + res.status);
        
        const text = await res.text();
        
        // Safety check
        if (text.trim().toLowerCase().startsWith('<!doctype html') || text.trim().toLowerCase().startsWith('<html')) {
             throw new Error("Received HTML instead of CSV. Check the Google Sheet permissions.");
        }


        rows = parseCSV(text);
        
        if (!rows || rows.length < 2) throw new Error('No data found in sheet.');


        headerRow = rows[0].map(h => (h||'').toString().trim());
        columnNames = headerRow.slice(1, 73);
        companionColumnIndex = detectCompanionColumn(headerRow);


        populateDropdowns();
        compat.textContent = 'Select plants to check compatibility.';
        desktop.innerHTML = '';
        mobile.innerHTML = '';
      } catch (err) {
        console.error(err);
        compat.textContent = 'Error loading plant data. Open console for details.';
        compat.style.color = 'crimson';
        document.getElementById('desktop-results').innerHTML = `<p style="padding:12px;color:#333"><strong>Error:</strong> ${err.message}<br><br>Make sure the sheet is published to the web.</p>`;
      }
    }


    function updateResults() {
      const selectedValues = DROPDOWN_IDS.map(id => document.getElementById(id).value).filter(v => v);
      document.getElementById('compatibility').textContent = buildCompatibilityMessage(selectedValues);
      document.getElementById('desktop-results').innerHTML = buildDesktopTable(selectedValues);
      document.getElementById('mobile-results').innerHTML = buildMobileTables(selectedValues);
    }


    function buildDesktopTable(selectedPlants) {
      if (!selectedPlants || !selectedPlants.length) return '';


      let html = '<table><thead><tr><th>Category</th>';
      selectedPlants.forEach(p => html += `<th>${escapeHtml(p)}</th>`);
      html += '</tr></thead><tbody>';


      for (let i = 0; i < columnNames.length; i++) {
        const col = columnNames[i] || '';
        html += `<tr><td><strong>${escapeHtml(col)}</strong></td>`;
        selectedPlants.forEach(plant => {
          const row = rows.find(r => (r[1]||'').trim() === plant);
          let val = row ? (row[i+1] || '') : 'No Data';
          val = (typeof val === 'string') ? escapeHtml(val) : escapeHtml(String(val));
          html += `<td>${val}</td>`;
        });
        html += '</tr>';
      }


      html += '</tbody></table>';
      return html;
    }


    function buildMobileTables(selectedPlants) {
      if (!selectedPlants || !selectedPlants.length) return '';


      let html = '';
      selectedPlants.forEach(plant => {
        const row = rows.find(r => (r[1]||'').trim() === plant);
        if (!row) {
          html += `<p>${escapeHtml(plant)}: No Data Found</p>`;
          return;
        }
        html += `<table class="plant-table"><thead><tr><th colspan="2">${escapeHtml(plant)}</th></tr></thead><tbody>`;
        for (let i = 0; i < columnNames.length; i++) {
          const col = columnNames[i] || '';
          let val = row[i+1] || '';
          val = (typeof val === 'string') ? escapeHtml(val) : escapeHtml(String(val));
          html += `<tr><td><strong>${escapeHtml(col)}</strong></td><td>${val}</td></tr>`;
        }
        html += '</tbody></table>';
      });
      return html;
    }


    function buildCompatibilityMessage(selectedPlants) {
      if (!selectedPlants || selectedPlants.length < 2) return 'Select at least two plants to check compatibility.';
      const pairs = [];
      for (let i = 0; i < selectedPlants.length; i++) {
        for (let j = i + 1; j < selectedPlants.length; j++) {
          const p1 = selectedPlants[i], p2 = selectedPlants[j];
          const compatible = checkCompatibility(p1, p2);
          pairs.push({ p1, p2, compatible });
        }
      }
      if (pairs.every(p => p.compatible)) return 'All selected plants have been known to be found with each other.';
      if (pairs.every(p => !p.compatible)) return 'None of the selected plants have historically been commonly found with each other.';
      return pairs.map(p => `${p.p1} & ${p.p2}: ${p.compatible ? 'Compatible' : 'Not Compatible'}`).join(' • ');
    }


    function checkCompatibility(name1, name2) {
      const row1 = rows.find(r => (r[1]||'').trim() === name1);
      const row2 = rows.find(r => (r[1]||'').trim() === name2);
      if (!row1 || !row2) return false;


      let compIdx = companionColumnIndex;
      if (compIdx < 0 || compIdx >= headerRow.length) {
        const guesses = [9, 11, 8];
        compIdx = guesses.find(g => g < headerRow.length) || -1;
      }


      const getList = (row) => {
        if (compIdx === -1) return [];
        const raw = (row[compIdx] || '').toString();
        if (!raw) return [];
        return raw.split(/[;,\/]/).map(s => s.trim().toLowerCase()).filter(Boolean);
      };


      const list1 = getList(row1);
      const list2 = getList(row2);


      const n1 = name1.toLowerCase().trim();
      const n2 = name2.toLowerCase().trim();


      const a = list1.some(item => item && item.length > 2 && (item === n2 || item.includes(n2) || n2.includes(item)));
      const b = list2.some(item => item && item.length > 2 && (item === n1 || item.includes(n1) || n1.includes(item)));


      return a || b;
    }


    function escapeHtml(str) {
      return (str || '').replace(/&/g, '&amp;')
                         .replace(/</g, '&lt;')
                         .replace(/>/g, '&gt;')
                         .replace(/"/g, '&quot;')
                         .replace(/'/g, '&#39;');
    }


    document.addEventListener('DOMContentLoaded', () => {
      init();
    });
  </script>
</body>
</html>