<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>West Coast Native Plant Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* SITE STYLES */
        body { font-family: 'Nunito Sans', sans-serif; margin: 0; padding: 0; background-color: #fdfdfd; color: #333; padding-top: 80px; }
        h1 { color: #175226; margin: 30px auto 20px; border-bottom: 2px solid #175226; padding-bottom: 10px; width: 95%; max-width: 1400px; text-align: left; }
        
        .controls-container { width: 95%; max-width: 1400px; margin: 0 auto; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; box-sizing: border-box; }
        .language-row { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .row-plant { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; }
        .input-group { display: flex; flex-direction: column; width: 100%; min-width: 200px; flex: 1; }
        
        label { margin-bottom: 5px; font-weight: bold; color: #175226; font-size: 14px; }
        select { padding: 10px; font-size: 15px; border: 1px solid #ccc; border-radius: 4px; background: #fff; width: 100%; }
        
        .toggle-container { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: bold; color: #175226; background: #e8f5e9; padding: 5px 10px; border-radius: 4px; white-space: nowrap; }
        .btn-download { background: #175226; color: white; border: none; padding: 10px 18px; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-download:hover { background: #2e7d32; }
        
        #compatibility { font-size: 16px; color: #175226; font-weight: bold; margin: 15px auto; padding: 10px 15px; background: #e8f5e9; border-left: 5px solid #175226; border-radius: 4px; max-width: 1400px; width: 95%; box-sizing: border-box;}
        
        #desktop-results { flex-grow: 1; min-height: 400px; overflow: auto; margin: 10px auto; border: 1px solid #ddd; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; width: 95%; max-width: 1400px; box-sizing: border-box; }
        #desktop-results table { width: 100%; table-layout: fixed; border-collapse: separate; border-spacing: 0; }
        #desktop-results th { background: #175226; color: white; font-weight: bold; text-align: left; padding: 12px 15px; border-right: 1px solid #0d3b18; border-bottom: 1px solid #0d3b18; position: sticky; top: 0; z-index: 10; }
        #desktop-results td { border-bottom: 1px solid #ddd; border-right: 1px solid #ddd; padding: 12px 15px; vertical-align: top; white-space: normal; word-wrap: break-word; min-width: 120px; background: #fff; }
        
        #mobile-results { width: 95%; margin: 0 auto; box-sizing: border-box; }
        #mobile-results .plant-table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #ddd; }
        #mobile-results .plant-table th, #mobile-results .plant-table td { border: 1px solid #ddd; padding: 10px; word-wrap: break-word; }
        #mobile-results .plant-table th { background: #175226; color: white; }
        
        @media (max-width: 768px) { #desktop-results { display: none; } #mobile-results { display: block; } }
        @media (min-width: 769px) { #mobile-results { display: none; } }
    </style>
</head>
<body id="top">

    <!-- 1. Header Injection Spot -->
    <div id="header-container"></div>
    
    <!-- 2. Main Title -->
    <h1>West Coast Native Plant Planner</h1>

    <div class="controls-container">
        <div class="language-row">
            <div class="input-group" style="max-width: 300px;">
                <label for="languageSelect">Select Language:</label>
                <select id="languageSelect">
                    <option value="1" selected>Common Name</option>
                    <option value="0">Latin Name</option>
                    <option value="3">Hul’qumi’num Name</option>
                    <option value="4">Halq̓eméylem Name</option>
                    <option value="5">Hul̓q̓umín̓um̓ Name</option>
                </select>
            </div>
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div class="toggle-container">
                    <input type="checkbox" id="hideEmptyRows" checked>
                    <label for="hideEmptyRows" style="margin:0; cursor:pointer;">Hide Empty Rows</label>
                </div>
                <button class="btn-download" id="downloadBtn">Download CSV</button>
            </div>
        </div>

        <div class="row-plant">
            <div class="input-group"><label>First Plant:</label><select id="dropdown1"><option value="">--Select--</option></select></div>
            <div class="input-group"><label>Second Plant:</label><select id="dropdown2"><option value="">--Select--</option></select></div>
        </div>
        <div class="row-plant">
            <div class="input-group"><label>Third Plant:</label><select id="dropdown3"><option value="">--Select--</option></select></div>
            <div class="input-group"><label>Fourth Plant:</label><select id="dropdown4"><option value="">--Select--</option></select></div>
        </div>
    </div>

    <div id="compatibility">Initializing...</div>
    <div id="desktop-results"></div>
    <div id="mobile-results"></div>

    <!-- SCRIPT SECTION -->
    <script>
        /* === A. HEADER LOADER & MOBILE LOGIC (Moved here so it works) === */
        
        // 1. Fetch Header HTML
        fetch("header.html")
            .then(response => response.text())
            .then(data => { document.getElementById("header-container").innerHTML = data; });

        // 2. Global Mobile Menu Functions
        window.openDrawer = function() {
            const drawer = document.getElementById('mobile-drawer');
            if(drawer) {
                drawer.classList.add('active'); 
                document.body.style.overflow = 'hidden'; 
            }
        };

        window.closeDrawer = function() {
            const drawer = document.getElementById('mobile-drawer');
            if(drawer) {
                drawer.classList.remove('active'); 
                document.body.style.overflow = 'auto';
            }
        };

        window.toggleMpanel = function(id) { 
            var el = document.getElementById(id); 
            if(el) el.classList.toggle('show'); 
        };

        // Safety close on resize
        window.onresize = function() { 
            if(window.innerWidth > 1000) window.closeDrawer(); 
        };


        /* === B. CALCULATOR APP LOGIC === */
        const googleSheetUrl = "https://docs.google.com/spreadsheets/d/1jhJeVNA53RsEBxKsJFTXzbY5adIrOamXbPNu2lEsM84/export?format=csv";
        const proxyUrl = "https://corsproxy.io/?"; 
        const DROPDOWN_IDS = ["dropdown1", "dropdown2", "dropdown3", "dropdown4"];
        const COMPATIBILITY_COLUMN_INDEX = 11; 
        let rows = []; let columnNames = []; let currentNameIndex = 1; 

        document.addEventListener("DOMContentLoaded", async () => {
            const statusBox = document.getElementById("compatibility");
            document.getElementById("languageSelect").addEventListener("change", handleLanguageChange);
            document.getElementById("hideEmptyRows").addEventListener("change", updateResults);
            document.getElementById("downloadBtn").addEventListener("click", downloadCSV);
            DROPDOWN_IDS.forEach(id => {
                document.getElementById(id).addEventListener("change", () => { updateResults(); saveStateToURL(); });
            });
            try {
                statusBox.textContent = "Finding ecosystem data...";
                const response = await fetch(proxyUrl + encodeURIComponent(googleSheetUrl));
                if (!response.ok) throw new Error("Server error");
                rows = parseCSV(await response.text());
                if(rows.length < 2) throw new Error("Empty data");
                columnNames = rows[0].slice(1, 55); 
                rows.shift(); 
                populateDropdowns(); loadStateFromURL();
                statusBox.textContent = "Select plants to check historical common compatibilities.";
            } catch (error) {
                console.error(error);
                statusBox.innerHTML = "Error loading database. Please refresh page.";
                statusBox.style.color = "red";
            }
        });
        
        // Helper functions...
        function cleanString(str) { return (str || "").toString().toLowerCase().replace(/[^a-z0-9]/g, ""); }
        function checkCompatibility(n1, n2) {
            const r1 = rows.find(r => (r[currentNameIndex]||"").trim() === n1);
            const r2 = rows.find(r => (r[currentNameIndex]||"").trim() === n2);
            if (!r1 || !r2) return false;
            const t1 = cleanString(r1[COMPATIBILITY_COLUMN_INDEX]), t2 = cleanString(r2[COMPATIBILITY_COLUMN_INDEX]);
            const ns1 = [cleanString(r1[1]), cleanString(r1[0])], ns2 = [cleanString(r2[1]), cleanString(r2[0])];
            return (ns2[0].length>3&&t1.indexOf(ns2[0])>-1)||(ns2[1].length>3&&t1.indexOf(ns2[1])>-1)||(ns1[0].length>3&&t2.indexOf(ns1[0])>-1)||(ns1[1].length>3&&t2.indexOf(ns1[1])>-1);
        }
        function buildCompatibilitySentence(sel) {
            if (sel.length < 2) return "Select at least two plants to check compatibility.";
            let g = [], b = [];
            for(let i=0; i<sel.length; i++) for(let j=i+1; j<sel.length; j++) checkCompatibility(sel[i], sel[j])?g.push(sel[i]+" & "+sel[j]):b.push(sel[i]+" & "+sel[j]);
            if (!b.length) return "All selected plants have been known to be found with each other!";
            if (!g.length) return "None of the selected plants have historically been commonly found with each other.";
            return `Compatible: [${g.join("; ")}]. Incompatible: [${b.join("; ")}].`;
        }
        function parseCSV(txt) {
            let r=[], rw=[], q=false, t='';
            for(let i=0;i<txt.length;i++){ let c=txt[i], n=txt[i+1]; if(c==='"'){q&&n==='"'?(t+='"',i++):(q=!q);} else if(c===','&&!q){rw.push(t);t='';} else if((c==='\r'||c==='\n')&&!q){ if(t||rw.length)rw.push(t);if(rw.length)r.push(rw);rw=[];t='';if(c==='\r'&&n==='\n')i++;} else t+=c; }
            if(t||rw.length){rw.push(t);r.push(rw);} return r;
        }
        function populateDropdowns() {
            rows.sort((a,b)=>(a[currentNameIndex]||"").localeCompare(b[currentNameIndex]||""));
            DROPDOWN_IDS.forEach(id=>{
                const dd=document.getElementById(id), cv=dd.value; dd.innerHTML='<option value="">--Select--</option>';
                rows.forEach(r=>{
                    const n=(r[currentNameIndex]||"").trim();
                    if(n&&n.toLowerCase()!=="no information") { let o=document.createElement("option"); o.value=n;o.textContent=n;dd.appendChild(o); }
                });
                if(cv) dd.value=cv;
            });
        }
        function handleLanguageChange(e){
            let oldI=currentNameIndex, newI=parseInt(e.target.value);
            let s=DROPDOWN_IDS.map(id=>{let v=document.getElementById(id).value; return v?rows.find(r=>(r[oldI]||"").trim()===v):null;});
            currentNameIndex=newI; populateDropdowns();
            DROPDOWN_IDS.forEach((id,i)=>{if(s[i]){let dd=document.getElementById(id),nm=(s[i][newI]||"").trim();for(let o of dd.options)if(o.value===nm)dd.value=nm;}});
            updateResults(); saveStateToURL();
        }
        function updateResults() {
            const s=DROPDOWN_IDS.map(id=>document.getElementById(id).value).filter(v=>v);
            const h=document.getElementById("hideEmptyRows").checked;
            document.getElementById("compatibility").textContent=buildCompatibilitySentence(s);
            document.getElementById("desktop-results").innerHTML=buildTable(s,h,false);
            document.getElementById("mobile-results").innerHTML=buildTable(s,h,true);
        }
        function buildTable(sel, hide, mob) {
            if (!sel.length) return "";
            if (mob) return sel.map(p=>{ let r=rows.find(row=>(row[currentNameIndex]||"").trim()===p); if(!r)return""; let h=`<table class="plant-table"><thead><tr><th colspan="2">${p}</th></tr></thead><tbody><tr><td>Latin</td><td>${r[0]}</td></tr>`; columnNames.forEach((c,i)=>{ let v=r[i+1]||""; if(!hide||v.replace(/no information/i,"").trim()) h+=`<tr><td><strong>${c}</strong></td><td>${v}</td></tr>`; }); return h+"</tbody></table>"; }).join("");
            let h = `<table><thead><tr><th>Category</th>${sel.map(p=>`<th>${p}</th>`).join("")}</tr></thead><tbody><tr><td><strong>Latin Name</strong></td>${sel.map(p=>`<td>${(rows.find(r=>(r[currentNameIndex]||"").trim()===p)||[])[0]||""}</td>`).join("")}</tr>`;
            columnNames.forEach((col, i) => { let rD=[], has=false; sel.forEach(p=>{ let r=rows.find(row=>(row[currentNameIndex]||"").trim()===p), v=r?(r[i+1]||""):""; if(v.replace(/no information/i,"").trim()) has=true; rD.push(v); }); if (!hide || has) h += `<tr><td><strong>${col}</strong></td>${rD.map(d=>`<td>${d}</td>`).join("")}</tr>`; }); return h+"</tbody></table>";
        }
        function saveStateToURL() { let p = new URLSearchParams(); DROPDOWN_IDS.forEach((id,i)=>{let v=document.getElementById(id).value;if(v)p.set(`p${i+1}`,v)}); p.set('lang', currentNameIndex); window.history.replaceState({},'',`${window.location.pathname}?${p}`); }
        function loadStateFromURL() { let p=new URLSearchParams(window.location.search); if(p.has('lang')){ currentNameIndex=parseInt(p.get('lang')); document.getElementById('languageSelect').value=currentNameIndex; } DROPDOWN_IDS.forEach((id,i)=>{ let v=p.get(`p${i+1}`); if(v){ let dd=document.getElementById(id); for(let o of dd.options)if(o.value===decodeURIComponent(v))dd.value=o.value;} }); updateResults(); }
        function downloadCSV() {
            const sel=DROPDOWN_IDS.map(id=>document.getElementById(id).value).filter(v=>v); if(!sel.length) return alert("Select plants first.");
            let c="\uFEFFCategory,Latin Name,"+sel.map(p=>`"${p}"`).join(",")+"\n";
            columnNames.forEach((col,i)=>{ let r=[],h=false; sel.forEach(p=>{ let rv=rows.find(w=>(w[currentNameIndex]||"").trim()===p),v=rv?(rv[i+1]||""):""; if(v.replace(/no information/i,"").trim()) h=true; r.push(`"${v.replace(/"/g,'""')}"`); }); if(!document.getElementById("hideEmptyRows").checked||h)c+=`"${col}","",`+r.join(",")+"\n"; });
            let a=document.createElement("a");a.href=URL.createObjectURL(new Blob([c],{type:"text/csv"}));a.download="plants.csv";a.click();
        }
    </script>
    <!-- === FOOTER INJECTION === -->
<div id="footer-container"></div>
<script>
    fetch("footer.html")
        .then(response => response.text())
        .then(data => { document.getElementById("footer-container").innerHTML = data; });
    
    // Smooth scroll for "Back to Top"
    document.documentElement.style.scrollBehavior = "smooth";
</script>
<!-- ======================= -->
</body>
</html>




