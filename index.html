<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>West Coast Native Plant Planner</title>
    
    <style>
        /* --- GENERAL STYLING --- */
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; padding: 20px; max-width: 100%; margin: 0; box-sizing: border-box; color: #333; background-color: #fdfdfd; height: 100vh; display: flex; flex-direction: column; }
        h1 { color: #175226; margin-bottom: 20px; border-bottom: 2px solid #175226; padding-bottom: 10px; width: 100%; max-width: 1400px; margin-left: auto; margin-right: auto; flex-shrink: 0; }
        .controls-container { width: 100%; max-width: 1400px; margin: 0 auto; flex-shrink: 0; background-color: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .language-row { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .row-plant { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; }
        .input-group { display: flex; flex-direction: column; width: 100%; }
        label { margin-bottom: 5px; font-weight: bold; color: #175226; font-size: 14px; }
        select { padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; width: 100%; }
        .toggle-container { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: bold; color: #175226; background: #e8f5e9; padding: 5px 10px; border-radius: 4px; white-space: nowrap; }
        .toggle-container input { cursor: pointer; width: 16px; height: 16px; }
        .btn-download { background-color: #175226; color: white; border: none; padding: 8px 15px; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: bold; }
        .btn-download:hover { background-color: #2e7d32; }
        
        @media (max-width: 768px) { .row-plant { flex-direction: column; align-items: stretch; gap: 10px; } .language-row { flex-direction: column; align-items: flex-start; } .btn-download { width: 100%; margin-top: 10px; } }
        
        /* Status Bar */
        #compatibility { font-size: 16px; color: #175226; font-weight: bold; margin: 15px auto; padding: 10px 15px; background-color: #e8f5e9; border-left: 5px solid #175226; border-radius: 4px; max-width: 1400px; width: 98%; flex-shrink: 0; }
        
        /* Table Areas */
        #desktop-results { flex-grow: 1; min-height: 400px; overflow: auto; margin-top: 10px; border: 1px solid #ddd; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; width: 100%; }
        #desktop-results table { width: 100%; table-layout: fixed; border-collapse: separate; border-spacing: 0; }
        #desktop-results th { background-color: #175226; color: white; font-weight: bold; text-align: left; padding: 12px 15px; border-right: 1px solid #0d3b18; border-bottom: 1px solid #0d3b18; position: sticky; top: 0; z-index: 10; }
        #desktop-results td { border-bottom: 1px solid #ddd; border-right: 1px solid #ddd; padding: 12px 15px; vertical-align: top; white-space: normal; word-wrap: break-word; overflow-wrap: break-word; min-width: 120px; background-color: #fff; }
        #desktop-results tbody tr:nth-child(even) td { background-color: #f4f8f4; }
        #mobile-results .plant-table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #ddd; }
        #mobile-results .plant-table th, #mobile-results .plant-table td { border: 1px solid #ddd; padding: 10px; word-wrap: break-word; }
        #mobile-results .plant-table th { background-color: #175226; color: white; }
        @media (max-width: 768px) { #desktop-results { display: none; } }
        @media (min-width: 769px) { #mobile-results { display: none; } }
    </style>
</head>
<body>


    <h1>West Coast Native Plant Planner</h1>


    <div class="controls-container">
        <div class="language-row">
            <div class="input-group" style="max-width: 300px;">
                <label for="languageSelect">Select Language:</label>
                <select id="languageSelect">
                    <option value="1" selected>Common Name</option>
                    <option value="0">Latin Name</option>
                    <option value="3">Hul’qumi’num Name</option>
                    <option value="4">Halq̓eméylem Name</option>
                    <option value="5">Hul̓q̓umín̓um̓ Name</option>
                </select>
            </div>
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div class="toggle-container">
                    <input type="checkbox" id="hideEmptyRows" checked>
                    <label for="hideEmptyRows" style="margin:0; cursor:pointer;">Hide Empty Rows</label>
                </div>
                <button class="btn-download" id="downloadBtn">Download CSV</button>
            </div>
        </div>


        <div class="row-plant">
            <div class="input-group"><label>First Plant:</label><select id="dropdown1"><option value="">--Select--</option></select></div>
            <div class="input-group"><label>Second Plant:</label><select id="dropdown2"><option value="">--Select--</option></select></div>
        </div>
        <div class="row-plant">
            <div class="input-group"><label>Third Plant:</label><select id="dropdown3"><option value="">--Select--</option></select></div>
            <div class="input-group"><label>Fourth Plant:</label><select id="dropdown4"><option value="">--Select--</option></select></div>
        </div>
    </div>


    <div id="compatibility">Initializing...</div>
    
    <div id="desktop-results"></div>
    <div id="mobile-results"></div>


    <script>
        const googleSheetUrl = "https://docs.google.com/spreadsheets/d/1jhJeVNA53RsEBxKsJFTXzbY5adIrOamXbPNu2lEsM84/export?format=csv";
        const proxyUrl = "https://corsproxy.io/?"; 
        const DROPDOWN_IDS = ["dropdown1", "dropdown2", "dropdown3", "dropdown4"];
        
        // --- CONFIGURATION ---
        // A=0, B=1, ... J=9, K=10, L=11
        // Targets the 12th Column (Column L)
        const COMPATIBILITY_COLUMN_INDEX = 11; 


        let rows = [];
        let columnNames = [];
        let currentNameIndex = 1; // Default to Common Name


        document.addEventListener("DOMContentLoaded", async () => {
            const statusBox = document.getElementById("compatibility");
            
            // Listeners
            document.getElementById("languageSelect").addEventListener("change", handleLanguageChange);
            document.getElementById("hideEmptyRows").addEventListener("change", updateResults);
            document.getElementById("downloadBtn").addEventListener("click", downloadCSV);
            DROPDOWN_IDS.forEach(id => {
                document.getElementById(id).addEventListener("change", () => { updateResults(); saveStateToURL(); });
            });


            try {
                statusBox.textContent = "Finding ecosystem data...";
                const response = await fetch(proxyUrl + encodeURIComponent(googleSheetUrl));
                if (!response.ok) throw new Error("Server error");
                
                const data = await response.text();
                rows = parseCSV(data);
                
                if(rows.length < 2) throw new Error("Empty data");
                
                columnNames = rows[0].slice(1, 55); 
                rows.shift(); 


                populateDropdowns();
                loadStateFromURL();
                statusBox.textContent = "Select plants to check historical common compatibilities.";


            } catch (error) {
                console.error(error);
                statusBox.innerHTML = "Error loading data. Please refresh.";
                statusBox.style.color = "red";
            }
        });


        // --- BROAD MATCH LOGIC ---
        function cleanString(str) {
            // Remove special chars, lower case, trim
            return (str || "").toString().toLowerCase().replace(/[^a-z0-9]/g, "");
        }


        function checkCompatibility(name1, name2) {
            // Get Row Objects
            const r1 = rows.find(r => (r[currentNameIndex]||"").trim() === name1);
            const r2 = rows.find(r => (r[currentNameIndex]||"").trim() === name2);
            if (!r1 || !r2) return false;


            // Get Raw Text from Compatibility Column (Index 11 / Col L)
            const text1 = (r1[COMPATIBILITY_COLUMN_INDEX] || "").toLowerCase();
            const text2 = (r2[COMPATIBILITY_COLUMN_INDEX] || "").toLowerCase();


            // Get Names to search for (Common AND Latin)
            const p1Common = (r1[1] || "").toLowerCase();
            const p1Latin  = (r1[0] || "").toLowerCase();
            
            const p2Common = (r2[1] || "").toLowerCase();
            const p2Latin  = (r2[0] || "").toLowerCase();


            // Let's Clean everything for comparison
            const cleanText1 = cleanString(text1); 
            const cleanText2 = cleanString(text2);
            
            const cleanP1Common = cleanString(p1Common);
            const cleanP1Latin = cleanString(p1Latin);
            const cleanP2Common = cleanString(p2Common);
            const cleanP2Latin = cleanString(p2Latin);


            // Check if names appear in the compatibility text
            const match1 = (cleanP2Common.length > 3 && cleanText1.indexOf(cleanP2Common) > -1) || 
                           (cleanP2Latin.length > 3 && cleanText1.indexOf(cleanP2Latin) > -1);


            const match2 = (cleanP1Common.length > 3 && cleanText2.indexOf(cleanP1Common) > -1) || 
                           (cleanP1Latin.length > 3 && cleanText2.indexOf(cleanP1Latin) > -1);


            return match1 || match2;
        }


        function buildCompatibilitySentence(selected) {
            if (selected.length < 2) return "Select at least two plants to check compatibility.";


            let pairs = [];
            for (let i = 0; i < selected.length; i++) {
                for (let j = i + 1; j < selected.length; j++) {
                    const p1 = selected[i], p2 = selected[j];
                    pairs.push({ p1, p2, compatible: checkCompatibility(p1, p2) });
                }
            }
            
            const good = pairs.filter(p => p.compatible);
            const bad = pairs.filter(p => !p.compatible);
            
            if (good.length === pairs.length) return "All selected plants have been known to be found with each other!";
            if (good.length === 0) return "None of the selected plants have historically been commonly found with each other.";
            
            const goodStr = good.map((p,i) => `${p.p1} & ${p.p2}`).join("; ");
            const badStr = bad.map((p,i) => `${p.p1} & ${p.p2}`).join("; ");
            return `Compatible: [${goodStr}]. Incompatible: [${badStr}].`;
        }


        // --- STANDARD FUNCTIONS ---
        function parseCSV(text) {
            let result = [], row = [], inQuotes = false, token = '';
            for (let i = 0; i < text.length; i++) {
                let char = text[i], next = text[i+1];
                if (char === '"') { inQuotes && next === '"' ? (token += '"', i++) : (inQuotes = !inQuotes); } 
                else if (char === ',' && !inQuotes) { row.push(token); token = ''; } 
                else if ((char === '\r' || char === '\n') && !inQuotes) {
                    if (token || row.length) row.push(token);
                    if (row.length) result.push(row);
                    row = []; token = '';
                    if (char === '\r' && next === '\n') i++;
                } else { token += char; }
            }
            if (token || row.length) { row.push(token); result.push(row); }
            return result;
        }


        function populateDropdowns() {
            rows.sort((a, b) => (a[currentNameIndex]||"").localeCompare(b[currentNameIndex]||""));
            DROPDOWN_IDS.forEach(id => {
                const dd = document.getElementById(id);
                dd.innerHTML = '<option value="">--Select--</option>';
                rows.forEach(row => {
                    const name = (row[currentNameIndex] || "").trim();
                    if (name && name.toLowerCase() !== "no information") {
                        const opt = document.createElement("option");
                        opt.value = name;
                        opt.textContent = name;
                        dd.appendChild(opt);
                    }
                });
            });
        }


        function handleLanguageChange(e) {
            const oldIndex = currentNameIndex;
            const newIndex = parseInt(e.target.value);
            const currentRows = DROPDOWN_IDS.map(id => {
                const val = document.getElementById(id).value;
                return val ? rows.find(r => (r[oldIndex]||"").trim() === val) : null;
            });
            currentNameIndex = newIndex;
            populateDropdowns();
            DROPDOWN_IDS.forEach((id, idx) => {
                if (currentRows[idx]) {
                    const dd = document.getElementById(id);
                    const newName = (currentRows[idx][newIndex] || "").trim();
                    for(let opt of dd.options) { if(opt.value === newName) dd.value = newName; }
                }
            });
            updateResults();
            saveStateToURL();
        }


        function updateResults() {
            const selected = DROPDOWN_IDS.map(id => document.getElementById(id).value).filter(v => v);
            const hideEmpty = document.getElementById("hideEmptyRows").checked;
            document.getElementById("compatibility").textContent = buildCompatibilitySentence(selected);
            document.getElementById("desktop-results").innerHTML = buildTable(selected, hideEmpty, false);
            document.getElementById("mobile-results").innerHTML = buildTable(selected, hideEmpty, true);
        }


        function buildTable(selected, hideEmpty, isMobile) {
            if (!selected.length) return "";
            if (isMobile) {
                let html = "";
                selected.forEach(p => {
                    const r = rows.find(row => (row[currentNameIndex]||"").trim() === p);
                    if (!r) return;
                    html += `<table class="plant-table"><thead><tr><th colspan="2">${p}</th></tr></thead><tbody>`;
                    html += `<tr><td><strong>Latin Name</strong></td><td>${r[0]}</td></tr>`;
                    columnNames.forEach((col, i) => {
                        let val = r[i+1] || "";
                        if (!hideEmpty || (val.toLowerCase().replace("no information","").trim() !== "")) {
                             html += `<tr><td><strong>${col}</strong></td><td>${val}</td></tr>`;
                        }
                    });
                    html += `</tbody></table>`;
                });
                return html;
            } else {
                let html = `<table><thead><tr><th>Category</th>`;
                selected.forEach(p => html += `<th>${p}</th>`);
                html += `</tr></thead><tbody>`;
                html += `<tr><td><strong>Latin Name</strong></td>`;
                selected.forEach(p => {
                    const r = rows.find(row => (row[currentNameIndex]||"").trim() === p);
                    html += `<td>${r ? r[0] : ""}</td>`;
                });
                html += `</tr>`;
                columnNames.forEach((col, i) => {
                    let rowData = [], hasData = false;
                    selected.forEach(p => {
                        const r = rows.find(row => (row[currentNameIndex]||"").trim() === p);
                        let val = r ? (r[i+1] || "") : "";
                        if (val.toLowerCase().replace("no information","").trim() !== "") hasData = true;
                        rowData.push(val);
                    });
                    if (!hideEmpty || hasData) {
                        html += `<tr><td><strong>${col}</strong></td>`;
                        rowData.forEach(d => html += `<td>${d}</td>`);
                        html += `</tr>`;
                    }
                });
                html += `</tbody></table>`;
                return html;
            }
        }


        function saveStateToURL() {
            const params = new URLSearchParams();
            DROPDOWN_IDS.forEach((id, i) => { if(document.getElementById(id).value) params.set(`p${i+1}`, document.getElementById(id).value); });
            params.set('lang', currentNameIndex);
            window.history.replaceState({}, '', `${window.location.pathname}?${params}`);
        }


        function loadStateFromURL() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('lang')) {
                currentNameIndex = parseInt(params.get('lang'));
                document.getElementById('languageSelect').value = currentNameIndex;
                populateDropdowns();
            }
            DROPDOWN_IDS.forEach((id, i) => {
                const val = params.get(`p${i+1}`);
                if(val) {
                    const dd = document.getElementById(id);
                    for(let opt of dd.options) { if(opt.value === decodeURIComponent(val)) dd.value = opt.value; }
                }
            });
            updateResults();
        }


        function downloadCSV() {
            const selected = DROPDOWN_IDS.map(id => document.getElementById(id).value).filter(v => v);
            if (selected.length === 0) return alert("Select plants first.");
            const hideEmpty = document.getElementById("hideEmptyRows").checked;
            let csv = "\uFEFFCategory,Latin Name," + selected.map(p=>`"${p}"`).join(",") + "\n";
            columnNames.forEach((col, i) => {
                let rowData = [], hasData = false;
                selected.forEach(p => {
                    const r = rows.find(row => (row[currentNameIndex]||"").trim() === p);
                    let val = r ? (r[i+1] || "") : "";
                    if (val.toLowerCase().replace("no information","").trim() !== "") hasData = true;
                    rowData.push(`"${val.replace(/"/g, '""')}"`);
                });
                if (!hideEmpty || hasData) csv += `"${col}","",` + rowData.join(",") + "\n";
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], {type: "text/csv;charset=utf-8;"}));
            link.download = "plant_comparison.csv";
            link.click();
        }
    </script>
</body>
</html>